<script>
document.addEventListener('DOMContentLoaded', function() {
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDZP3KwrswjdiDgMhvRe3cH0ngOqthEA9U",
        authDomain: "outesbookreview.firebaseapp.com",
        projectId: "outesbookreview",
        storageBucket: "outesbookreview.appspot.com",
        messagingSenderId: "768178017652",
        appId: "1:768178017652:web:bd358f130f8165f2f90821",
        measurementId: "G-YM24P69ZVW"
    };
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (error) {
        document.getElementById('reviews-container').innerHTML = `
            <div class="error">
                <p>Firebase initialization failed. Please check your configuration.</p>
                <p>Error: ${error.message}</p>
            </div>
        `;
    }

    const db = firebase.firestore();
    const reviewsCollection = db.collection('reviews');
    let allReviews = [];
    let loggedInUser = null; // A variable to store the logged-in user's name

    // --- NEW: LOGIN LOGIC ---
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const nameInput = document.getElementById('name').value;
        const codeInput = document.getElementById('code').value;
        const messageEl = document.getElementById('message');

        messageEl.textContent = "";

        const usersCollection = db.collection('users');
        const q = usersCollection.where("name", "==", nameInput).where("code", "==", codeInput);

        try {
            const querySnapshot = await q.get();
            if (!querySnapshot.empty) {
                // Login successful!
                const userDoc = querySnapshot.docs[0].data();
                loggedInUser = userDoc.name; // Store the user's name
                showMainContent();
            } else {
                // Login failed
                messageEl.textContent = "Invalid name or code.";
            }
        } catch (error) {
            console.error("Error during login: ", error);
            messageEl.textContent = "An error occurred. Please try again.";
        }
    });

    // --- NEW: FUNCTION TO SHOW MAIN CONTENT AFTER LOGIN ---
    function showMainContent() {
        // Hide the login form container
        document.getElementById('login-container').style.display = 'none';
        // Show the main content and navigation
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('main-nav').style.display = 'flex';
        // Now that the content is visible, load the reviews
        loadReviews();
        setupRealtimeListener();
    }
    
    // All of your original functions
    function loadReviews() {
        document.getElementById('reviews-container').innerHTML = '<div class="loading">Loading reviews from the cloud</div>';
        reviewsCollection.orderBy("date", "desc").get()
        .then((querySnapshot) => {
            allReviews = [];
            querySnapshot.forEach((doc) => {
                allReviews.push({ id: doc.id, ...doc.data() });
            });
            displayContent();
        })
        .catch((error) => {
            document.getElementById('reviews-container').innerHTML = `
                <div class="error">
                    <p>Error loading reviews: ${error.message}</p>
                    <button onclick="loadReviews()" class="btn">Try Again</button>
                </div>
            `;
        });
    }

    function setupRealtimeListener() {
        reviewsCollection.orderBy("date", "desc")
        .onSnapshot((querySnapshot) => {
            const newReviews = [];
            querySnapshot.forEach((doc) => {
                newReviews.push({ id: doc.id, ...doc.data() });
            });
            if (newReviews.length !== allReviews.length || JSON.stringify(newReviews) !== JSON.stringify(allReviews)) {
                allReviews = newReviews;
                displayContent();
            }
        });
    }

    function displayContent() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        let reviewsToShow = allReviews;
        if (searchTerm) {
            reviewsToShow = allReviews.filter(review =>
                (review.bookTitle && review.bookTitle.toLowerCase().includes(searchTerm)) ||
                (review.bookAuthor && review.bookAuthor.toLowerCase().includes(searchTerm)) ||
                (review.review && review.review.toLowerCase().includes(searchTerm)) ||
                (review.studentName && review.studentName.toLowerCase().includes(searchTerm))
            );
        }
        displayReviews(reviewsToShow, searchTerm);
        displayBookGrid(allReviews);
    }

    function displayReviews(reviewsToShow, searchTerm) {
        const container = document.getElementById('reviews-container');
        const heading = document.getElementById('reviews-heading');
        container.innerHTML = '';

        heading.textContent = searchTerm ? `Search Results for "${searchTerm}"` : 'Recent Reviews';

        const reviewsToDisplay = reviewsToShow.slice(0, 5);

        if (reviewsToDisplay.length === 0) {
            container.innerHTML = `<p>${searchTerm ? 'No reviews found matching your search.' : 'No reviews yet. Be the first to add one!'}</p>`;
            return;
        }

        reviewsToDisplay.forEach(review => {
            const card = document.createElement('div');
            card.className = 'review-card';
            card.onclick = () => searchByBook(review.bookTitle);
            card.innerHTML = `
                <div class="review-header">
                    <span class="reviewer">${review.studentName || 'Anonymous'}</span>
                    <span class="review-date">${review.date ? new Date(review.date).toLocaleDateString() : 'No date'}</span>
                </div>
                <div class="rating">${getStarRating(review.rating, false)}</div>
                <h3>
                    <span class="review-book-icon" title="Book">&#128218;</span>
                    ${review.bookTitle || 'No Title'}
                    <span style="color: var(--text-muted); font-weight:400; font-size: 0.9em;">by ${review.bookAuthor || 'Unknown Author'}</span>
                </h3>
                <p>${review.review || ''}</p>
            `;
            container.appendChild(card);
        });
    }

    function displayBookGrid(sourceReviews) {
        const grid = document.getElementById('book-grid');
        const featuredSection = document.getElementById('feat-i-section');
        const searchTerm = document.getElementById('search-input').value.trim();
        grid.innerHTML = '';
        featuredSection.style.display = searchTerm ? 'none' : 'block';
        if (searchTerm) return;

        const uniqueBooksMap = new Map();
        sourceReviews.forEach(r => {
            if (r.bookTitle && !uniqueBooksMap.has(r.bookTitle)) {
                uniqueBooksMap.set(r.bookTitle, r);
            }
        });

        const uniqueBooks = Array.from(uniqueBooksMap.values());
        const selectedBooks = [];
        const usedIdx = new Set();
        while (selectedBooks.length < 20 && usedIdx.size < uniqueBooks.length) {
            const idx = Math.floor(Math.random() * uniqueBooks.length);
            if (!usedIdx.has(idx)) {
                selectedBooks.push(uniqueBooks[idx]);
                usedIdx.add(idx);
            }
        }

        const svgBook = `<svg class="svg-book" viewBox="0 0 48 48" fill="none">
            <rect x="4" y="8" width="40" height="32" rx="6" fill="#3778c2"/>
            <rect x="8" y="12" width="32" height="24" rx="4" fill="#fff"/>
            <path d="M12 16h24M12 20h24M12 24h24" stroke="#f7b267" stroke-width="2" stroke-linecap="round"/>
            <rect x="4" y="8" width="40" height="32" rx="6" stroke="#43aa8b" stroke-width="2"/>
        </svg>`;

        selectedBooks.forEach(review => {
            const card = document.createElement('div');
            card.className = 'book-card';
            card.onclick = () => searchByBook(review.bookTitle);
            const avgRating = getAverageRating(review.bookTitle);
            card.innerHTML = `
                <div class="book-cover">${svgBook}</div>
                <div class="book-info">
                    <h3 class="book-title">${review.bookTitle}</h3>
                    <p class="book-author">${review.bookAuthor}</p>
                    <div class="rating">${getStarRating(avgRating, true)}</div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function getAverageRating(bookTitle) {
        const bookReviews = allReviews.filter(r => r.bookTitle === bookTitle);
        if (bookReviews.length === 0) return 0;
        const total = bookReviews.reduce((sum, r) => sum + r.rating, 0);
        return total / bookReviews.length;
    }

    function getStarRating(rating, showCount) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) stars += '<i class="fas fa-star"></i>';
            else if (i - 0.5 <= rating) stars += '<i class="fas fa-star-half-alt"></i>';
            else stars += '<i class="far fa-star"></i>';
        }
        if (showCount) stars += ` <span style="color: var(--text-muted); font-size: 0.9em;">(${rating.toFixed(1)})</span>`;
        return stars;
    }

    function showNotification(message, isError = false) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.background = isError ? '#e74c3c' : 'var(--accent-blue)';
        notification.style.display = 'block';
        setTimeout(() => { notification.style.display = 'none'; }, 3000);
    }

    function searchReviews() {
        const searchTerm = document.getElementById('search-input').value;
        document.getElementById('clear-search-btn').style.display = searchTerm ? 'inline-block' : 'none';
        displayContent();
    }

    function clearSearch() {
        document.getElementById('search-input').value = '';
        document.getElementById('clear-search-btn').style.display = 'none';
        displayContent();
    }

    function searchByBook(bookTitle) {
        if (!bookTitle) return;
        document.getElementById('search-input').value = bookTitle;
        document.getElementById('clear-search-btn').style.display = 'inline-block';
        displayContent();
        document.getElementById('reviews').scrollIntoView({ behavior: 'smooth' });
    }

    // --- UPDATED: REVIEW FORM SUBMISSION ---
    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitBtn = form.querySelector('button');
        const rating = form.querySelector('input[name="rating"]:checked');
        
        if (!rating) {
            showNotification('Please select a rating.', true);
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        // Check if a user is logged in
        if (!loggedInUser) {
            showNotification('You must be logged in to submit a review.', true);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Review';
            return;
        }

        const newReview = {
            studentName: loggedInUser, // Use the logged-in user's name
            bookTitle: form.bookTitle.value,
            bookAuthor: form.bookAuthor.value,
            rating: parseInt(rating.value),
            review: form.review.value,
            date: new Date().toISOString()
        };

        try {
            await reviewsCollection.add(newReview);
            showNotification('Review submitted successfully!');
            form.reset();
        } catch (error) {
            showNotification('Failed to submit review. Please try again.', true);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Review';
        }
    });

    // --- OTHER EVENT LISTENERS ---
    document.getElementById('home-btn').addEventListener('click', () => {
        clearSearch();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    document.getElementById('clear-search-btn').addEventListener('click', clearSearch);
    document.getElementById('search-input').addEventListener('keyup', e => {
        if (e.key === 'Enter') searchReviews();
    });

    // window.onload is no longer needed since content is controlled by login
});
</script>
